<html lang="en"></html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no" />
    <title>Covid-19 in Viet Nam</title>

    <link rel="stylesheet" href="https://js.arcgis.com/4.30/esri/themes/light/main.css" />
    <link rel="icon" href="favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" href="css/style.css" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>
    <script src="https://js.arcgis.com/4.30/"></script>

<script>
  require([
  "esri/WebMap",
  "esri/views/MapView",
  "esri/layers/FeatureLayer",
  "esri/core/reactiveUtils",
  "esri/widgets/Legend"
], function(WebMap, MapView, FeatureLayer, reactiveUtils, Legend) {
  // Tạo đối tượng WebMap với ID của bạn
  const webmap = new WebMap({
    portalItem: { id: "1e254684c9bd41259e296eea06a0b1b0" } // Thay thế với ID WebMap của bạn
  });

  // Tạo đối tượng MapView
  const view = new MapView({
    map: webmap,
    container: "viewDiv"
  });

  // Khi MapView sẵn sàng
  view.when().then(() => {
    // Tạo biểu đồ khi view đã sẵn sàng
    createCharts();

    // Lấy lớp dữ liệu từ WebMap
    const layer = webmap.layers.getItemAt(1); // Lấy lớp thứ hai trong danh sách lớp

    // Cấu hình các trường dữ liệu
    layer.outFields = [
      "province",
      "total_infected_cases",
      "today_infected_cases",
      "deaths",
      "total_recovered_cases",
      "date"
    ];

    // Khi lớp dữ liệu sẵn sàng
    view.whenLayerView(layer).then((layerView) => {
      reactiveUtils
        .whenOnce(() => !layerView.updating)
        .then(() => {
          // Xử lý sự kiện khi người dùng nhấp chuột hoặc kéo chuột
          view.on(["click", "drag"], (event) => {
            // Vô hiệu hóa điều hướng khi kéo chuột
            event.stopPropagation();

            // Truy vấn dữ liệu và cập nhật biểu đồ
            queryStatsOnDrag(layerView, event)
              .then(updateCharts)
              .catch((error) => {
                if (error.name !== "AbortError") {
                  console.error(error);
                }
              });
          });
        });
    });

    // Cấu hình popupTemplate
    const popupTemplate = {
      title: "{province}",
      content: `
        <b>Total Infected Cases:</b> {total_infected_cases}<br>
        <b>Today's Infected Cases:</b> {today_infected_cases}<br>
        <b>Deaths:</b> {deaths}<br>
        <b>Date:</b> {date}<br>
        <b>Total Recovered Cases:</b> {total_recovered_cases}<br>
        <b>Latitude:</b> {latitude}<br>
        <b>Longitude:</b> {longtitude}
      `
    };

    layer.popupTemplate = popupTemplate;

    // Thêm widget Legend nếu cần
    const legend = new Legend({
      view: view,
      layerInfos: [{ layer: layer }]
    });
    view.ui.add(legend, "bottom-right");
  });

  // Hàm để tạo biểu đồ (chưa có trong đoạn mã của bạn)
  function createCharts() {
    // Implement chart creation logic here
  }

  // Hàm để truy vấn dữ liệu khi kéo chuột (cần định nghĩa)
  function queryStatsOnDrag(layerView, event) {
    // Implement query logic here
    return Promise.resolve(); // Placeholder
  }

  // Hàm để cập nhật biểu đồ (cần định nghĩa)
  function updateCharts() {
    // Implement chart update logic here
  }
});

</script>
  </head>

  <body>
    <div id="viewDiv"></div>
    <div id="panel">
      <div style="padding: 15px">
        <canvas id="infected-cases-chart" height="250" width="550"></canvas>
      </div>
    </div>
  </body>
</html>